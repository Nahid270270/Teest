import os
import threading
import asyncio
from flask import Flask, request, jsonify
from pyrogram import Client, filters
from pyrogram.types import Message
from dotenv import load_dotenv
import re
import traceback

# m3u8-To-MP4 рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржорзНржкрзЛрж░рзНржЯ ржХрж░рзБржи
import m3u8_To_MP4

# .env ржлрж╛ржЗрж▓ ржерзЗржХрзЗ ржкрж░рж┐ржмрзЗрж╢ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж▓рзЛржб ржХрж░рзБржи
load_dotenv()

# --- Flask ржЕрзНржпрж╛ржк рж╕рзЗржЯржЖржк ---
app = Flask(__name__)

# --- Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рж╕рзЗржЯржЖржк ---
API_ID = int(os.getenv("API_ID"))
API_HASH = os.getenv("API_HASH")
BOT_TOKEN = os.getenv("BOT_TOKEN")
DOWNLOAD_DIR = os.getenv("DOWNLOAD_DIR", "downloads") # ржбрж┐ржлрж▓рзНржЯ ржбрж┐рж░рзЗржХрзНржЯрж░рж┐

# ржбрж╛ржЙржирж▓рзЛржб ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐ ржХрж░рзБржи ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ
os.makedirs(DOWNLOAD_DIR, exist_ok=True)

# Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рзБржи
bot = Client(
    "m3u8_downloader_bot",
    api_id=API_ID,
    api_hash=API_HASH,
    bot_token=BOT_TOKEN
)

# --- ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржи ---
async def download_m3u8_video(client: Client, message: Message, m3u8_url: str):
    status_message = None  # status_message ржнрзНржпрж╛рж░рж┐ржпрж╝рзЗржмрж▓ ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬ ржХрж░рзБржи
    try:
        status_message = await message.reply_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ... ржПржХржЯрзБ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред")

        # ржлрж╛ржЗрж▓ ржирж╛ржо рждрзИрж░рж┐ ржХрж░рзБржи (рж▓рж┐ржВржХ ржерзЗржХрзЗ ржЕржержмрж╛ рж░рзНржпрж╛ржирзНржбржо)
        # рж▓рж┐ржВржХрзЗрж░ рж╢рзЗрж╖ ржЕржВрж╢рзЗрж░ `m3u8` ржмрж╛ржж ржжрж┐ржпрж╝рзЗ ржирж╛ржо рждрзИрж░рж┐ ржХрж░ржмрзЗ
        file_name_match = re.search(r'[^/]+(?=\.(m3u8|M3U8))', m3u8_url)
        if file_name_match:
            base_name = file_name_match.group(0).replace('-', '_').replace('.', '_')[:50] # ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо ржкрж░рж┐рж╖рзНржХрж╛рж░ рж░рж╛ржЦрзБржи
        else:
            base_name = f"video_{os.urandom(4).hex()}" # рж░рзНржпрж╛ржирзНржбржо ржирж╛ржо ржпржжрж┐ рж▓рж┐ржВржХ ржерзЗржХрзЗ ржирж╛ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝

        output_path = os.path.join(DOWNLOAD_DIR, f"{base_name}.mp4")

        await status_message.edit_text(f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╣ржЪрзНржЫрзЗ: `{m3u8_url}`\nржПржЯрж┐ ржХрж┐ржЫрзБ рж╕ржоржпрж╝ ржирж┐рждрзЗ ржкрж╛рж░рзЗ... тП│")

        def _sync_download_task():
            try:
                # m3u8_To_MP4 ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи
                m3u8_To_MP4.download(m3u8_url, custom_file_name=output_path)
                return True
            except Exception as e:
                print(f"Error during m3u8 download with m3u8_To_MP4: {e}")
                # ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржПрж░рж░ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзБржи
                traceback.print_exc()
                return False

        # ржПржХржЯрж┐ ржирждрзБржи ржерзНрж░рзЗржбрзЗ рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛рж╕ ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржи ржЪрж╛рж▓рж╛ржи
        # ржПржЯрж┐ Pyrogram ржПрж░ Asyncio ржЗржнрзЗржирзНржЯ рж▓рзБржкржХрзЗ ржмрзНрж▓ржХ ржХрж░ржмрзЗ ржирж╛
        download_successful = await asyncio.to_thread(_sync_download_task)

        if download_successful and os.path.exists(output_path) and os.path.getsize(output_path) > 0:
            await status_message.edit_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи! ржПржЦржи ржЖржкрж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ... ЁЯУд")
            await message.reply_document(
                document=output_path,
                caption=f"**ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи! тЬЕ**\n\nрж▓рж┐ржЩрзНржХ: `{m3u8_url}`" # ржХрзНржпрж╛ржкрж╢ржирзЗ рж▓рж┐ржВржХ ржпрзЛржЧ ржХрж░рзБржи
            )
            # ржбрж╛ржЙржирж▓рзЛржб рж╢рзЗрж╖рзЗ ржлрж╛ржЗрж▓ржЯрж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рзЗ ржжрж┐ржи
            os.remove(output_path)
            print(f"ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржлрж╛ржЗрж▓ ржбрж┐рж▓рж┐ржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ: {output_path}")
        else:
            if status_message: # status_message рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
                await status_message.edit_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред рж▓рж┐ржВржХрзЗ рж╕ржорж╕рзНржпрж╛ ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ ржЕржержмрж╛ рж╕рж╛рж░рзНржнрж╛рж░ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░рзЗржирж┐ред тЭМ")

    except Exception as e:
        error_message = f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ рж╕ржоржпрж╝ ржПржХржЯрж┐ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд рждрзНрж░рзБржЯрж┐ рж╣ржпрж╝рзЗржЫрзЗ: {e}\n\n```python\n{traceback.format_exc()}\n```"
        print(f"ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржирзЗ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд рждрзНрж░рзБржЯрж┐: {e}")
        traceback.print_exc()
        if status_message: # status_message рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
            await status_message.edit_text(error_message)


# --- Pyrogram ржорзЗрж╕рзЗржЬ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
@bot.on_message(filters.command("start") & filters.private)
async def start_command(client, message):
    await message.reply_text("ЁЯСЛ **рж╣рзНржпрж╛рж▓рзЛ!** ржЖржорж┐ ржПржХржЯрж┐ m3u8 ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржбрж╛рж░ ржмржЯред\n\nржЖржорж╛ржХрзЗ ржПржХржЯрж┐ **m3u8 рж▓рж┐ржВржХ** ржкрж╛ржарж╛ржи ржПржмржВ ржЖржорж┐ ржнрж┐ржбрж┐ржУржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзЗ ржЖржкржирж╛ржХрзЗ ржкрж╛ржарж┐ржпрж╝рзЗ ржжрзЗржмред")

# рж╕ржм ржЯрзЗржХрзНрж╕ржЯ ржорзЗрж╕рзЗржЬ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░ржмрзЗ
@bot.on_message(filters.text & filters.private)
async def handle_any_text_message(client, message: Message):
    m3u8_url = message.text.strip()

    # рж░рзЗржЬрзЗржХрзНрж╕ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи ржпрзЗ ржПржЯрж┐ ржПржХржЯрж┐ ржмрзИржз M3U8 рж▓рж┐ржВржХ
    # $ ржЪрж┐рж╣рзНржи ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ .m3u8/M3U8 ржПрж░ ржкрж░ ржЖрж░ ржХрж┐ржЫрзБ ржирзЗржЗ
    if re.match(r'https?://.*\.(m3u8|M3U8)$', m3u8_url, re.IGNORECASE): # re.IGNORECASE ржпрзЛржЧ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржЫрзЛржЯ/ржмржбрж╝ рж╣рж╛рждрзЗрж░ ржЕржХрзНрж╖рж░рзЗрж░ ржЬржирзНржп
        await download_m3u8_video(client, message, m3u8_url)
    else:
        await message.reply_text("ЁЯдФ ржжрзБржГржЦрж┐ржд, ржПржЯрж┐ ржПржХржЯрж┐ ржмрзИржз m3u8 рж▓рж┐ржВржХ ржмрж▓рзЗ ржоржирзЗ рж╣ржЪрзНржЫрзЗ ржирж╛ред\n\nржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржПржХржЯрж┐ **рж╕ржарж┐ржХ m3u8 рж▓рж┐ржВржХ** ржкрж╛ржарж╛ржиред")

# --- ржмржЯ ржЪрж╛рж▓рж╛ржирзЛрж░ ржлрж╛ржВрж╢ржи (ржЖрж▓рж╛ржжрж╛ ржерзНрж░рзЗржбрзЗ) ---
def run_bot_in_thread():
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        print("Pyrogram ржмржЯ рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ...")
        bot.run()
    except Exception as e:
        print(f"ржмржЯ ржЪрж╛рж▓рж╛ржирзЛрж░ рж╕ржоржпрж╝ рждрзНрж░рзБржЯрж┐: {e}")
        traceback.print_exc() # ржПрж░рж░ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рж╛рж░ ржЬржирзНржп
    finally:
        loop.close()
        print("Pyrogram ржмржЯ ржмржирзНржз рж╣ржпрж╝рзЗржЫрзЗред")

# --- Flask рж░рзБржЯрж╕ ---
@app.route('/')
def home():
    return "ржЖржкржирж╛рж░ Pyrogram ржмржЯ ржПржмржВ Flask ржЕрзНржпрж╛ржк рж╕ржЪрж▓ ржЖржЫрзЗ! ржПржХржЯрж┐ m3u8 рж▓рж┐ржВржХ ржкрж╛ржарж╛ржиред"

@app.route('/health')
def health_check():
    # ржмржЯ ржерзНрж░рзЗржб рж╕ржЪрж▓ ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ, рждржмрзЗ рж╕рж╛ржзрж╛рж░ржг Flask Health Check-ржПрж░ ржЬржирзНржп "OK" ржпржерзЗрж╖рзНржЯ
    return "OK", 200

# --- ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржПржирзНржЯрзНрж░рж┐ ржкржпрж╝рзЗржирзНржЯ ---
if __name__ == '__main__':
    # Pyrogram ржмржЯржХрзЗ ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ ржерзНрж░рзЗржбрзЗ ржЪрж╛рж▓рж╛ржи
    bot_thread = threading.Thread(target=run_bot_in_thread)
    bot_thread.start()

    # Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рж╛ржи
    # ржПржЯрж┐ web server рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗ ржПржмржВ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░ржмрзЗ
    port = int(os.getenv("PORT", 10000))
    print(f"Flask ржЕрзНржпрж╛ржк ржкрзЛрж░рзНржЯ {port} ржП ржЪрж▓ржЫрзЗ...")
    app.run(host='0.0.0.0', port=port)

