import os
import threading
import asyncio
from flask import Flask, request, jsonify
from pyrogram import Client, filters
from pyrogram.types import Message
from dotenv import load_dotenv
import re
import traceback

# m3u8-To-MP4 рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржорзНржкрзЛрж░рзНржЯ ржХрж░рзБржи
import m3u8_To_MP4

# .env ржлрж╛ржЗрж▓ ржерзЗржХрзЗ ржкрж░рж┐ржмрзЗрж╢ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж▓рзЛржб ржХрж░рзБржи
load_dotenv()

# --- Flask ржЕрзНржпрж╛ржк рж╕рзЗржЯржЖржк ---
app = Flask(__name__)

# --- Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рж╕рзЗржЯрж┐ржВрж╕ рж▓рзЛржб ржХрж░рзБржи ---
# ржПржЗ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ржЧрзБрж▓рзЛ ржЧрзНрж▓рзЛржмрж╛рж▓рж┐ рж░рж╛ржЦрж╛ рж╣ржпрж╝рзЗржЫрзЗ ржХрж╛рж░ржг ржПржЧрзБрж▓рзЛ рж╕ржм ржлрж╛ржВрж╢ржирзЗржЗ ржмрзНржпржмрж╣рзГржд рж╣ржмрзЗред
API_ID = int(os.getenv("API_ID"))
API_HASH = os.getenv("API_HASH")
BOT_TOKEN = os.getenv("BOT_TOKEN")
DOWNLOAD_DIR = os.getenv("DOWNLOAD_DIR", "downloads") # ржбрж┐ржлрж▓рзНржЯ ржбрж┐рж░рзЗржХрзНржЯрж░рж┐

# ржбрж╛ржЙржирж▓рзЛржб ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐ ржХрж░рзБржи ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ
os.makedirs(DOWNLOAD_DIR, exist_ok=True)

# Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЕржмржЬрзЗржХрзНржЯржХрзЗ ржЧрзНрж▓рзЛржмрж╛рж▓рж┐ ржШрзЛрж╖ржгрж╛ ржХрж░рзБржи,
# ржХрж┐ржирзНрждрзБ ржПржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ 'run_bot_in_thread' ржПрж░ ржнрж┐рждрж░рзЗ ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬ рж╣ржмрзЗред
# ржПржЯрж┐ ржПржХржЯрж┐ ржкрзНрж▓рзЗрж╕рж╣рзЛрж▓рзНржбрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗред
# ржПрж░ ржЙржжрзНржжрзЗрж╢рзНржп рж╣рж▓рзЛ @bot.on_message ржбрзЗржХрзЛрж░рзЗржЯрж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛рж░ рж╕рзБржпрзЛржЧ ржжрзЗржУржпрж╝рж╛ред
bot_client_instance = None


# --- ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржи ---
async def download_m3u8_video(client: Client, message: Message, m3u8_url: str):
    status_message = None
    try:
        status_message = await message.reply_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ... ржПржХржЯрзБ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред")

        file_name_match = re.search(r'[^/]+(?=\.(m3u8|M3U8))', m3u8_url)
        if file_name_match:
            # ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо ржкрж░рж┐рж╖рзНржХрж╛рж░ ржУ ржирж┐рж░рж╛ржкржж рж░рж╛ржЦрждрзЗ ржмрж┐рж╢рзЗрж╖ ржЕржХрзНрж╖рж░ ржмрж╛ржж ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝рзЗржЫрзЗ
            base_name = re.sub(r'[^\w\-_\.]', '', file_name_match.group(0))[:50]
        else:
            base_name = f"video_{os.urandom(4).hex()}"

        output_path = os.path.join(DOWNLOAD_DIR, f"{base_name}.mp4")

        await status_message.edit_text(f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╣ржЪрзНржЫрзЗ: `{m3u8_url}`\nржПржЯрж┐ ржХрж┐ржЫрзБ рж╕ржоржпрж╝ ржирж┐рждрзЗ ржкрж╛рж░рзЗ... тП│")

        def _sync_download_task():
            try:
                # m3u8_To_MP4 ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи
                m3u8_To_MP4.download(m3u8_url, custom_file_name=output_path)
                return True
            except Exception as e:
                print(f"Error during m3u8 download with m3u8_To_MP4: {e}")
                traceback.print_exc()
                return False

        # ржПржХржЯрж┐ ржирждрзБржи ржерзНрж░рзЗржбрзЗ рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛рж╕ ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржи ржЪрж╛рж▓рж╛ржи
        download_successful = await asyncio.to_thread(_sync_download_task)

        if download_successful and os.path.exists(output_path) and os.path.getsize(output_path) > 0:
            await status_message.edit_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи! ржПржЦржи ржЖржкрж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ... ЁЯУд")
            await message.reply_document(
                document=output_path,
                caption=f"**ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи! тЬЕ**\n\nрж▓рж┐ржЩрзНржХ: `{m3u8_url}`"
            )
            os.remove(output_path)
            print(f"ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржлрж╛ржЗрж▓ ржбрж┐рж▓рж┐ржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ: {output_path}")
        else:
            if status_message:
                await status_message.edit_text("ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред рж▓рж┐ржВржХрзЗ рж╕ржорж╕рзНржпрж╛ ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ ржЕржержмрж╛ рж╕рж╛рж░рзНржнрж╛рж░ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░рзЗржирж┐ред тЭМ")

    except Exception as e:
        error_message = f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ рж╕ржоржпрж╝ ржПржХржЯрж┐ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд рждрзНрж░рзБржЯрж┐ рж╣ржпрж╝рзЗржЫрзЗ: {e}\n\n```python\n{traceback.format_exc()}\n```"
        print(f"ржбрж╛ржЙржирж▓рзЛржб ржлрж╛ржВрж╢ржирзЗ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд рждрзНрж░рзБржЯрж┐: {e}")
        traceback.print_exc()
        if status_message:
            await status_message.edit_text(error_message)

# --- Pyrogram ржорзЗрж╕рзЗржЬ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
# ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ рж╕рж░рж╛рж╕рж░рж┐ 'bot_client_instance' ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ ржХрж╛рж░ржг ржПржЯрж┐ рж░рж╛ржиржЯрж╛ржЗржорзЗ рждрзИрж░рж┐ рж╣ржмрзЗред
# ржбрзЗржХрзЛрж░рзЗржЯрж░рзЗрж░ ржЬржирзНржп Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржПржХржЯрж┐ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ ржкрзНрж░ржпрж╝рзЛржЬржиред
# рж╕ржорж╛ржзрж╛ржи: ржЖржорж░рж╛ ржПржХржЯрж┐ ржлрзЗржЗржХ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЕржмржЬрзЗржХрзНржЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржм ржпрж╛ ржбрзЗржХрзЛрж░рзЗржЯрж░ рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗ
# ржПржмржВ ржкрж░рзЗ ржЖрж╕рж▓ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЕржмржЬрзЗржХрзНржЯ ржжрзНржмрж╛рж░рж╛ ржкрзНрж░рждрж┐рж╕рзНржерж╛ржкрж┐ржд рж╣ржмрзЗред
# ржПржЗ ржкржжрзНржзрждрж┐ржЯрж┐ рж╕рж╛ржзрж╛рж░ржгржд рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ржЧрзБрж▓рзЛрждрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ ржпржЦржи ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рж░рж╛ржиржЯрж╛ржЗржорзЗ ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬ рж╣ржпрж╝ред

# ржПржХржЯрж┐ рж╕рж╛ржзрж╛рж░ржг Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЕржмржЬрзЗржХрзНржЯ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрзЗржХрзЛрж░рзЗржЯрж░ рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░рж╛рж░ ржЬржирзНржп)
bot = Client("dummy_client", no_updates=True) # no_updates=True ржПржЯрж┐ржХрзЗ рж╕рждрзНржпрж┐ржЗ ржЖржкржбрзЗржЯ рж░рж┐рж╕рж┐ржн ржХрж░рж╛ ржерзЗржХрзЗ ржмрж┐рж░ржд рж░рж╛ржЦржмрзЗ

@bot.on_message(filters.command("start") & filters.private)
async def start_command(client, message):
    await message.reply_text("ЁЯСЛ **рж╣рзНржпрж╛рж▓рзЛ!** ржЖржорж┐ ржПржХржЯрж┐ m3u8 ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржбрж╛рж░ ржмржЯред\n\nржЖржорж╛ржХрзЗ ржПржХржЯрж┐ **m3u8 рж▓рж┐ржВржХ** ржкрж╛ржарж╛ржи ржПржмржВ ржЖржорж┐ ржнрж┐ржбрж┐ржУржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзЗ ржЖржкржирж╛ржХрзЗ ржкрж╛ржарж┐ржпрж╝рзЗ ржжрзЗржмред")

@bot.on_message(filters.text & filters.private)
async def handle_any_text_message(client, message: Message):
    m3u8_url = message.text.strip()

    if re.match(r'https?://.*\.(m3u8|M3U8)$', m3u8_url, re.IGNORECASE):
        await download_m3u8_video(client, message, m3u8_url)
    else:
        await message.reply_text("ЁЯдФ ржжрзБржГржЦрж┐ржд, ржПржЯрж┐ ржПржХржЯрж┐ ржмрзИржз m3u8 рж▓рж┐ржВржХ ржмрж▓рзЗ ржоржирзЗ рж╣ржЪрзНржЫрзЗ ржирж╛ред\n\nржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржПржХржЯрж┐ **рж╕ржарж┐ржХ m3u8 рж▓рж┐ржВржХ** ржкрж╛ржарж╛ржиред")

# --- ржмржЯ ржЪрж╛рж▓рж╛ржирзЛрж░ ржлрж╛ржВрж╢ржи (ржЖрж▓рж╛ржжрж╛ ржерзНрж░рзЗржбрзЗ) ---
def run_bot_in_thread():
    global bot_client_instance # ржЧрзНрж▓рзЛржмрж╛рж▓ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рж╛рж░ ржЬржирзНржп

    # Pyrogram ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржХрзЗ ржПржЗ ржерзНрж░рзЗржбрзЗрж░ ржнрзЗрждрж░рзЗ рждрзИрж░рж┐ ржХрж░рзБржи
    # ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░ржмрзЗ ржпрзЗ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржЯрж┐ рждрж╛рж░ ржирж┐ржЬрж╕рзНржм ржЗржнрзЗржирзНржЯ рж▓рзБржкрзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНрждред
    bot_client_instance = Client(
        "m3u8_downloader_bot",
        api_id=API_ID,
        api_hash=API_HASH,
        bot_token=BOT_TOKEN
    )

    # ржбрзЗржХрзЛрж░рзЗржЯрж░ ржжрзНржмрж╛рж░рж╛ ржпрзБржХрзНржд рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ржЧрзБрж▓рзЛржХрзЗ ржЖрж╕рж▓ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕рзЗ ржХржкрж┐ ржХрж░рзБржи
    # ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ @bot.on_message ржжрзНржмрж╛рж░рж╛ рж╕ржВржЬрзНржЮрж╛ржпрж╝рж┐ржд ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛ
    # рж╕ржарж┐ржХржнрж╛ржмрзЗ bot_client_instance ржПрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд рж╣ржмрзЗред
    for handler in bot.handlers:
        bot_client_instance.add_handler(handler[0], handler[1].group) # handler[1].group ржПржХржЯрж┐ рж╕рж╛ржзрж╛рж░ржг Pyrogram рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ржЧрзНрж░рзБржк


    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        print("Pyrogram ржмржЯ рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ...")
        loop.run_until_complete(bot_client_instance.start())
        print("Pyrogram ржмржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ рж╢рзБрж░рзБ рж╣ржпрж╝рзЗржЫрзЗред")
        loop.run_forever() # ржЗржнрзЗржирзНржЯ рж▓рзБржкржХрзЗ ржЕржирж┐рж░рзНржжрж┐рж╖рзНржЯржХрж╛рж▓рзЗрж░ ржЬржирзНржп ржЪрж╛рж▓рзБ рж░рж╛ржЦржмрзЗ
    except Exception as e:
        print(f"ржмржЯ ржЪрж╛рж▓рж╛ржирзЛрж░ рж╕ржоржпрж╝ рждрзНрж░рзБржЯрж┐: {e}")
        traceback.print_exc()
    finally:
        # ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмржирзНржз рж╣ржУржпрж╝рж╛рж░ рж╕ржоржпрж╝ ржмржЯ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржмржирзНржз ржХрж░рзБржи
        print("Pyrogram ржмржЯ ржмржирзНржз рж╣ржЪрзНржЫрзЗ...")
        if bot_client_instance.is_connected: # ржпржжрж┐ ржмржЯ ржХрж╛ржирзЗржХрзНржЯрзЗржб ржерж╛ржХрзЗ, рждржмрзЗржЗ рж╕рзНржЯржк ржХрж░рзБржи
            loop.run_until_complete(bot_client_instance.stop())
        loop.close()
        print("Pyrogram ржмржЯ ржмржирзНржз рж╣ржпрж╝рзЗржЫрзЗред")

# --- Flask рж░рзБржЯрж╕ ---
@app.route('/')
def home():
    # ржмржЯ ржЪрж▓ржЫрзЗ ржХрж┐ржирж╛ рждрж╛ ржПржЦрж╛ржирзЗ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ
    status = "ржЪрж▓ржЫрзЗ" if bot_client_instance and bot_client_instance.is_connected else "рж╢рзБрж░рзБ рж╣ржпрж╝ржирж┐/ржмржирзНржз ржЖржЫрзЗ"
    return f"ржЖржкржирж╛рж░ Pyrogram ржмржЯ ржПржмржВ Flask ржЕрзНржпрж╛ржк рж╕ржЪрж▓ ржЖржЫрзЗ! ржмржЯ ржмрж░рзНрждржорж╛ржирзЗ: {status}ред ржПржХржЯрж┐ m3u8 рж▓рж┐ржВржХ ржкрж╛ржарж╛ржиред"

@app.route('/health')
def health_check():
    # ржмржЯ ржХрж╛ржирзЗржХрзНржЯрзЗржб ржХрж┐ржирж╛ рждрж╛ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзЗ рж╕рзНржмрж╛рж╕рзНржерзНржп ржЕржмрж╕рзНржерж╛ рж░рж┐ржкрзЛрж░рзНржЯ ржХрж░рзБржи
    if bot_client_instance and bot_client_instance.is_connected:
        return "OK", 200
    else:
        return "Bot Not Connected", 503 # ржпржжрж┐ ржмржЯ ржХрж╛ржирзЗржХрзНржЯрзЗржб ржирж╛ ржерж╛ржХрзЗ рждрж╛рж╣рж▓рзЗ 503 (Service Unavailable) ржкрж╛ржарж╛ржи

# --- ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржПржирзНржЯрзНрж░рж┐ ржкржпрж╝рзЗржирзНржЯ ---
if __name__ == '__main__':
    # Pyrogram ржмржЯржХрзЗ ржПржХржЯрж┐ ржЖрж▓рж╛ржжрж╛ ржерзНрж░рзЗржбрзЗ ржЪрж╛рж▓рж╛ржи
    # daemon=True ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржпрж╛рждрзЗ ржорзВрж▓ Flask ржЕрзНржпрж╛ржк ржмржирзНржз рж╣рж▓рзЗ ржПржЯрж┐ржУ ржмржирзНржз рж╣ржпрж╝ред
    bot_thread = threading.Thread(target=run_bot_in_thread, daemon=True)
    bot_thread.start()

    # Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рж╛ржи
    port = int(os.getenv("PORT", 10000))
    print(f"Flask ржЕрзНржпрж╛ржк ржкрзЛрж░рзНржЯ {port} ржП ржЪрж▓ржЫрзЗ...")
    app.run(host='0.0.0.0', port=port)

